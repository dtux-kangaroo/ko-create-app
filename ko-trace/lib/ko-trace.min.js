!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Kotrace=t()}(this,function(){"use strict";function t(){for(var e=+new Date,t=0;e==+new Date;)t++;return e.toString(16)+t.toString(16)}var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},r={session_expiration:18e5,status:1,debug:!1},c=function(e){return e?r[e]:r},s=function(e){return n(r,e),r},u=function(){var e=(screen.height*screen.width).toString(16);return t()+"-"+Math.random().toString(16).replace(".","")+"-"+function(){for(var e,t=navigator.userAgent,n=void 0,o=[],r=0,a=function(e,t){for(var n=void 0,r=0,n=0;n<t.length;n++)r|=o[n]<<8*n;return e^r},n=0;n<t.length;n++)e=t.charCodeAt(n),o.unshift(255&e),4<=o.length&&(r=a(r,o),o=[]);return 0<o.length&&(r=a(r,o)),r.toString(16)}()+"-"+e+"-"+t()};function o(e,t,n,r,o){var a,i="",c="",s="";r&&(i=(a=(a=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i))?a[0]:"")?"; domain=."+a:""),n&&((a=new Date).setTime(a.getTime()+n),c="; expires="+a.toGMTString()),o&&(s="; secure"),document.cookie=e+"="+encodeURIComponent(t)+c+"; path=/"+i+s}function d(e){var t=c().session_expiration;(""===document.referrer||document.referrer.indexOf(location.host)<0)&&(a.set("DTTRACE_SESSIONID",e,t),localStorage&&localStorage.setItem("DTTRACE_SESSIONID",e),localStorage&&localStorage.setItem("DTTRACE_SESSIONID_EXPIRE",(new Date).getTime()+t))}var a={get:function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var o=n[r];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return decodeURIComponent(o.substring(t.length,o.length))}return null},set:o,remove:function(e,t){o(e,"",-1,t)}},i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};function f(){return document&&{$title:document.title,$referrer:document.referrer,$referrer_host:function(e){var t=/:\/\/.*\//;if(t.test(e))return e.match(t)[0].replace(/(:\/\/)|(\/)/g,"")}(document.referrer),$cookie:document.cookie}}function l(){var e,t=function(){var e=c("getUserId");if("function"==typeof e)return e()}(),n=function(){var e=c("getSessionId");if("function"==typeof e)return e()}();return i({},screen&&{$screen_height:screen.height,$screen_width:screen.width,$screen_colordepth:screen.colorDepth},location&&{$url:location.href,$url_path:location.pathname+location.hash},navigator&&{$lang:navigator.language,$user_agent:navigator.userAgent},f(),{$dtsession_id:function(){if(a.get("DTTRACE_SESSIONID"))return a.get("DTTRACE_SESSIONID");if(localStorage&&localStorage.getItem("DTTRACE_SESSIONID")&&localStorage.getItem("DTTRACE_SESSIONID_EXPIRE")>(new Date).getTime())return localStorage.getItem("DTTRACE_SESSIONID");var e=u();return d(e),e}(),$app_key:c("appKey"),$DTTID:((e=localStorage?localStorage.getItem("$DTTID"):a.get("$DTTID"))||(e=u(),a.set("$DTTID",e,15552e6),localStorage&&localStorage.setItem("$DTTID",e)),e),$user_id:t,$session_id:n,is_debug:c("debug")})}var g={},m={get:function(e){var t=i({},l(),g);return e?t[e]:t},set:function(e){return i(g,e)},remove:function(e){var t=g[e];return delete g[e],t}},v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function p(e,t){t=function(e){var t,n="";for(t in e)""!=n&&e[t]&&(n+="&"),e[t]&&(n+=t+"="+encodeURIComponent(e[t]));return n}(t);new Image(1,1).src=e+"?"+t}var h=function(e){var t,n,r,o,a=c();a.status?(t=(new Date).getTime(),n=v({},m.get(),e,{$timestamp:t}),-1<navigator.userAgent.indexOf("Android")||-1<navigator.userAgent.indexOf("Adr")?(r=n,o=function(){p(a.server_url,n)},"object"===("undefined"==typeof DtstackData_APP_JS_Bridge?"undefined":_(DtstackData_APP_JS_Bridge))&&(DtstackData_APP_JS_Bridge.dttrace_verify||DtstackData_APP_JS_Bridge.dttrace_track)?DtstackData_APP_JS_Bridge.dttrace_verify?DtstackData_APP_JS_Bridge.dttrace_verify(JSON.stringify(r)):SensorsData_APP_JS_Bridge.dttrace_track(JSON.stringify(r)):o()):navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?(r=n,o=function(){p(a.server_url,n)},"object"===_(window.DtstackData_APP_JS_Bridge)&&window.DtstackData_APP_JS_Bridge.dttrace_track?window.DtstackData_APP_JS_Bridge.dttrace_track(r):o()):p(a.server_url,n)):console.error(new Error("Kotrace not init,please excute Kotrace.init"))};var S,y,D=(y=!(S=[]),document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){y?e.call(document):S.push(e)});function e(e){e=e||window.event;y||"onreadystatechange"===e.type&&"complete"!==document.readyState||(S.forEach(function(e){e.call(document)}),y=!0,S=[])}function w(e,t,n,r){return e.addEventListener?(e.addEventListener(t,n,r),!0):e.attachEvent?e.attachEvent("on"+t,n):void(e["on"+t]=n)}var b=function(e){if(!e.preventDefault)return{};var t=e.target||e.srcElement;return{$element_id:t.id,$element_name:t.name,$element_content:t.innerHTML,$element_class_name:t.className,$element_type:t.nodeName,$element_target_url:t.href,$screenX:e.screenX,$screenY:e.screenY}},E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};function T(n,r,o){if("number"==typeof n){if("function"==typeof r)return function(){var e=window.event||arguments[0],t=r.apply(this,arguments);h(I({$event_id:n},b(e),o,t))};console.error(new Error("the second param in Kotrace.carryRocket must be function"))}else console.error(new Error("the first param in Kotrace.carryRocket must be number"))}return{init:function(e){var t=e.serverUrl,n=e.getSessionId,r=e.getUserId,o=e.sessionExpiration,a=e.debug,i=e.params;try{if(!t)throw new Error("parameter's serverUrl is required!")}catch(e){s({status:0}),console.error(e)}c("status")&&(e={},"string"==typeof t&&I(e,{server_url:t}),"boolean"==typeof a&&I(e,{debug:a}),"number"==typeof o&&I(e,{session_expiration:o}),"function"==typeof n&&I(e,{getSessionId:n}),"function"==typeof r&&I(e,{getUserId:r}),s(e),m.set(i),D(function(){var t=(new Date).getTime();d(u());var e=function(){h({$event_id:3001})};"onpageshow"in window?w(window,"pageshow",e,!1):w(window,"load",e,!1);e=document.getElementsByTagName("body")[0];w(e,"click",function(e){var e=window.event||e,t=e.target||e.srcElement;if(-1<t.className.indexOf("kotrace")){var n,r={};for(n in t.dataset)-1<n.indexOf("kotrace")&&(r[n.substring(7).toLocaleLowerCase()]=t.dataset[n]);r.eventid&&(r.$event_id=r.eventid,delete r.eventid),h(E({},b(e),r))}},!1);e=function(){var e=(new Date).getTime();h({$event_id:3002,$stay_time:e-t})};"onpagehide"in window?w(window,"pagehide",e,!1):w(window,"beforeunload",e,!1)}))},launchRocket:function(e,t,n){"number"==typeof e?(t=I({$event_id:e},t),n&&I(t,b(n)),h(t)):console.error(new Error("the first param in Kotrace.launchRocket must be number"))},carryRocket:T,KotraceRocket:function(r,e){if("number"==typeof r){var o=I({$event_id:r},e);return function(e,t,n){return e[t]=T(r,e[t],o),e}}console.error(new Error("the first param in @KotraceRocket must be number"))},cookie:a,Param:m}});
